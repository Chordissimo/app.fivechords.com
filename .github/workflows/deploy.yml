name: aichords

on:
  workflow_dispatch:
  pull_request:
    types:
      - closed
    branches:
      - 'staging'
      - 'main'

concurrency:
  group: "${{ github.ref }}"
  cancel-in-progress: true

jobs:  
  Deploy:
    name: "Deploying services"
    if: startsWith(github.event.pull_request.title, '[Release]') && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      NGINX: ${{ contains(github.event.pull_request.title, '[nginx]') &&  'nginx' || '' }}
      AICHORDS: ${{ contains(github.event.pull_request.title, '[airchords]') &&  'airchords' || '' }}
      MONGO: ${{ contains(github.event.pull_request.title, '[mongo]') &&  'mongo' || '' }}
      NAMESPACE: ${{ github.ref == 'refs/heads/staging' && 'get_st' || 'get' }}
      USER: "ci_user" 
      SSH_KEY: ${{ github.ref == 'refs/heads/staging' && secrets.STAGING_USER_KEY || secrets.PRODUCTION_USER_KEY }}
      SERVER: ${{ github.ref == 'refs/heads/staging' && '184.105.181.159' || '184.105.181.159' }}
      TAGERT_DIR: ${{ github.ref == 'refs/heads/staging' && 'src_stage' || 'src' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: sync&build
        run: |-
          echo "$SSH_KEY" | tr -d '\r' > ssh_key
          chmod 0600 ssh_key
          ssh -o StrictHostKeyChecking=no -i ssh_key $USER@$SERVER "mkdir -p /home/$USER/$DIR"
          rsync -a -e "ssh -o StrictHostKeyChecking=no -i ssh_key" ./src $USER@$SERVER:$TAGERT_DIR
          #ssh -o StrictHostKeyChecking=no -i ssh_key $USER@$SERVER "cd /home/$USER/$TAGERT_DIR; sudo ENV=$NAMESPACE SRV="$NGINX,$AICHORDS,$MONGO" bash scripts/build_docker.sh"
          
  DeployChords:
    name: "Updating chords JSON"
    if: startsWith(github.event.pull_request.title, '[Chords]') && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      NAMESPACE: ${{ github.ref == 'refs/heads/staging' && 'get_st' || 'get' }}
      SERVER: ${{ github.ref == 'refs/heads/staging' && '184.105.181.159' || '184.105.181.159' }}
      USER: "ci_user" 
      SSH_KEY: ${{ github.ref == 'refs/heads/staging' && secrets.STAGING_USER_KEY || secrets.PRODUCTION_USER_KEY }}
      DIR: ${{ github.ref == 'refs/heads/staging' && 'src_stage' || 'src' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: sync&build
        run: |-
          echo "$SSH_KEY" | tr -d '\r' > ssh_key
          chmod 0600 ssh_key
          rsync -a -e "ssh -o StrictHostKeyChecking=no -i ssh_key" ./config/chords $USER@$SERVER:$DIR/config
