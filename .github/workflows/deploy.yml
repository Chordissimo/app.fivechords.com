name: aichords

on:
  workflow_dispatch:
  pull_request:
    types:
      - closed
    branches:
      - 'staging'
      - 'master'

concurrency:
  group: "${{ github.ref }}"
  cancel-in-progress: true

jobs:  
  Deploy:
    name: "Deploying services"
    if: startsWith(github.event.pull_request.title, '[Release]') && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      NGINX: ${{ contains(github.event.pull_request.title, '[nginx]') &&  'nginx' || '' }}
      AICHORDS: ${{ contains(github.event.pull_request.title, '[aichords]') &&  'aichords' || '' }}
      MONGO: ${{ contains(github.event.pull_request.title, '[mongo]') &&  'mongo' || '' }}
      NAMESPACE: ${{ github.ref == 'refs/heads/staging' && 'staging' || 'production' }}
      USER: "ci_user" 
      SSH_KEY: ${{ github.ref == 'refs/heads/staging' && secrets.STAGING_USER_KEY || secrets.PRODUCTION_USER_KEY }}
      SERVER: ${{ github.ref == 'refs/heads/staging' && '35.159.4.155' || '74.82.29.215' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: sync&build
        run: |-
          echo "$SSH_KEY" | tr -d '\r' > ssh_key
          chmod 0600 ssh_key
          ssh -o StrictHostKeyChecking=no -i ssh_key $USER@$SERVER "mkdir -p /home/$USER/app"
          rsync -a -e "ssh -o StrictHostKeyChecking=no -i ssh_key" ./ $USER@$SERVER:app
          ssh -o StrictHostKeyChecking=no -i ssh_key $USER@$SERVER "cd /home/$USER/app; sudo ENV=$NAMESPACE SRV="$NGINX,$AICHORDS,$MONGO" bash scripts/build_docker.sh"
          
  DeployChords:
    name: "Updating chords JSON"
    if: startsWith(github.event.pull_request.title, '[Chords]') && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      NAMESPACE: ${{ github.ref == 'refs/heads/staging' && 'staging' || 'production' }}
      SERVER: ${{ github.ref == 'refs/heads/staging' && '35.159.4.155' || '74.82.29.215' }}
      USER: "ci_user" 
      SSH_KEY: ${{ github.ref == 'refs/heads/staging' && secrets.STAGING_USER_KEY || secrets.PRODUCTION_USER_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: sync&build
        run: |-
          echo "$SSH_KEY" | tr -d '\r' > ssh_key
          chmod 0600 ssh_key
          rsync -a -e "ssh -o StrictHostKeyChecking=no -i ssh_key" ./config/chords $USER@$SERVER:app/config
